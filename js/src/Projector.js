THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.z=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld);this.positionScreen.copy(e.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2;this.material=null};THREE.Projector=function(){var e,r,t=[],i=0,n,o,a=[],s=0,l,c,u=[],p=0,f,E,v=[],h=0,d,m,R=[],x=0,T={objects:[],lights:[],elements:[]},y=new THREE.Vector3,H=new THREE.Vector4,w=new THREE.Box3(new THREE.Vector3((-1),(-1),(-1)),new THREE.Vector3(1,1,1)),g=new THREE.Box3,b=new Array(3),M=new Array(4),S=new THREE.Matrix4,z=new THREE.Matrix4,V,j=new THREE.Matrix4,L=new THREE.Matrix3,C=new THREE.Frustum,k=new THREE.Vector4,N=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project().");e.project(r)};this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");e.unproject(r)};this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var W=function(){var e=[];var r=[];var t=null;var i=null;var o=new THREE.Matrix3;var s=function(n){t=n;i=t.material;o.getNormalMatrix(t.matrixWorld);e.length=0;r.length=0};var c=function(e){var r=e.position;var t=e.positionWorld;var i=e.positionScreen;t.copy(r).applyMatrix4(V);i.copy(t).applyMatrix4(z);var n=1/i.w;i.x*=n;i.y*=n;i.z*=n;e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1};var u=function(e,r,t){n=P();n.position.set(e,r,t);c(n)};var p=function(r,t,i){e.push(r,t,i)};var E=function(e,t){r.push(e,t)};var v=function(e,r,t){if(e.visible===true||r.visible===true||t.visible===true)return true;b[0]=e.positionScreen;b[1]=r.positionScreen;b[2]=t.positionScreen;return w.isIntersectionBox(g.setFromPoints(b))};var h=function(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0};var d=function(e,r){var i=a[e];var n=a[r];f=O();f.id=t.id;f.v1.copy(i);f.v2.copy(n);f.z=(i.positionScreen.z+n.positionScreen.z)/2;f.material=t.material;T.elements.push(f)};var m=function(n,s,c){var u=a[n];var p=a[s];var f=a[c];if(v(u,p,f)===false)return;if(i.side===THREE.DoubleSide||h(u,p,f)===true){l=I();l.id=t.id;l.v1.copy(u);l.v2.copy(p);l.v3.copy(f);l.z=(u.positionScreen.z+p.positionScreen.z+f.positionScreen.z)/3;for(var E=0;E<3;E++){var d=arguments[E]*3;var m=l.vertexNormalsModel[E];m.set(e[d],e[d+1],e[d+2]);m.applyMatrix3(o).normalize();var R=arguments[E]*2;var x=l.uvs[E];x.set(r[R],r[R+1])}l.vertexNormalsLength=3;l.material=t.material;T.elements.push(l)}};return{setObject:s,projectVertex:c,checkTriangleVisibility:v,checkBackfaceCulling:h,pushVertex:u,pushNormal:p,pushUv:E,pushLine:d,pushTriangle:m}};var B=new W;this.projectScene=function(t,i,n,s){c=0;E=0;m=0;T.elements.length=0;if(t.autoUpdate===true)t.updateMatrixWorld();if(i.parent===undefined)i.updateMatrixWorld();S.copy(i.matrixWorldInverse.getInverse(i.matrixWorld));z.multiplyMatrices(i.projectionMatrix,S);C.setFromMatrix(z);r=0;T.objects.length=0;T.lights.length=0;t.traverseVisible(function(r){if(r instanceof THREE.Light){T.lights.push(r)}else if(r instanceof THREE.Mesh||r instanceof THREE.Line||r instanceof THREE.Sprite){if(r.material.visible===false)return;if(r.frustumCulled===false||C.intersectsObject(r)===true){e=F();e.id=r.id;e.object=r;y.setFromMatrixPosition(r.matrixWorld);y.applyProjection(z);e.z=y.z;T.objects.push(e)}}});if(n===true){T.objects.sort(G)}for(var u=0,p=T.objects.length;u<p;u++){var v=T.objects[u].object;var h=v.geometry;B.setObject(v);V=v.matrixWorld;o=0;if(v instanceof THREE.Mesh){if(h instanceof THREE.BufferGeometry){var R=h.attributes;var x=h.offsets;if(R.position===undefined)continue;var w=R.position.array;for(var g=0,b=w.length;g<b;g+=3){B.pushVertex(w[g],w[g+1],w[g+2])}if(R.normal!==undefined){var M=R.normal.array;for(var g=0,b=M.length;g<b;g+=3){B.pushNormal(M[g],M[g+1],M[g+2])}}if(R.uv!==undefined){var W=R.uv.array;for(var g=0,b=W.length;g<b;g+=2){B.pushUv(W[g],W[g+1])}}if(R.index!==undefined){var A=R.index.array;if(x.length>0){for(var u=0;u<x.length;u++){var q=x[u];var J=q.index;for(var g=q.start,b=q.start+q.count;g<b;g+=3){B.pushTriangle(A[g]+J,A[g+1]+J,A[g+2]+J)}}}else{for(var g=0,b=A.length;g<b;g+=3){B.pushTriangle(A[g],A[g+1],A[g+2])}}}else{for(var g=0,b=w.length/3;g<b;g+=3){B.pushTriangle(g,g+1,g+2)}}}else if(h instanceof THREE.Geometry){var K=h.vertices;var Q=h.faces;var X=h.faceVertexUvs[0];L.getNormalMatrix(V);var Y=v.material;var Z=Y instanceof THREE.MeshFaceMaterial;var $=Z===true?v.material:null;for(var _=0,ee=K.length;_<ee;_++){var re=K[_];y.copy(re);if(Y.morphTargets===true){var te=h.morphTargets;var ie=v.morphTargetInfluences;for(var ne=0,oe=te.length;ne<oe;ne++){var ae=ie[ne];if(ae===0)continue;var se=te[ne];var le=se.vertices[_];y.x+=(le.x-re.x)*ae;y.y+=(le.y-re.y)*ae;y.z+=(le.z-re.z)*ae}}B.pushVertex(y.x,y.y,y.z)}for(var ce=0,ue=Q.length;ce<ue;ce++){var pe=Q[ce];var Y=Z===true?$.materials[pe.materialIndex]:v.material;if(Y===undefined)continue;var fe=Y.side;var Ee=a[pe.a];var ve=a[pe.b];var he=a[pe.c];if(B.checkTriangleVisibility(Ee,ve,he)===false)continue;var de=B.checkBackfaceCulling(Ee,ve,he);if(fe!==THREE.DoubleSide){if(fe===THREE.FrontSide&&de===false)continue;if(fe===THREE.BackSide&&de===true)continue}l=I();l.id=v.id;l.v1.copy(Ee);l.v2.copy(ve);l.v3.copy(he);l.normalModel.copy(pe.normal);if(de===false&&(fe===THREE.BackSide||fe===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(L).normalize();var me=pe.vertexNormals;for(var Re=0,xe=Math.min(me.length,3);Re<xe;Re++){var Te=l.vertexNormalsModel[Re];Te.copy(me[Re]);if(de===false&&(fe===THREE.BackSide||fe===THREE.DoubleSide)){Te.negate()}Te.applyMatrix3(L).normalize()}l.vertexNormalsLength=me.length;var ye=X[ce];if(ye!==undefined){for(var He=0;He<3;He++){l.uvs[He].copy(ye[He])}}l.color=pe.color;l.material=Y;l.z=(Ee.positionScreen.z+ve.positionScreen.z+he.positionScreen.z)/3;T.elements.push(l)}}}else if(v instanceof THREE.Line){if(h instanceof THREE.BufferGeometry){var R=h.attributes;if(R.position!==undefined){var w=R.position.array;for(var g=0,b=w.length;g<b;g+=3){B.pushVertex(w[g],w[g+1],w[g+2])}if(R.index!==undefined){var A=R.index.array;for(var g=0,b=A.length;g<b;g+=2){B.pushLine(A[g],A[g+1])}}else{var we=v.mode===THREE.LinePieces?2:1;for(var g=0,b=w.length/3-1;g<b;g+=we){B.pushLine(g,g+1)}}}}else if(h instanceof THREE.Geometry){j.multiplyMatrices(z,V);var K=v.geometry.vertices;if(K.length===0)continue;Ee=P();Ee.positionScreen.copy(K[0]).applyMatrix4(j);var we=v.mode===THREE.LinePieces?2:1;for(var _=1,ee=K.length;_<ee;_++){Ee=P();Ee.positionScreen.copy(K[_]).applyMatrix4(j);if((_+1)%we>0)continue;ve=a[o-2];k.copy(Ee.positionScreen);N.copy(ve.positionScreen);if(U(k,N)===true){k.multiplyScalar(1/k.w);N.multiplyScalar(1/N.w);f=O();f.id=v.id;f.v1.positionScreen.copy(k);f.v2.positionScreen.copy(N);f.z=Math.max(k.z,N.z);f.material=v.material;if(v.material.vertexColors===THREE.VertexColors){f.vertexColors[0].copy(v.geometry.colors[_]);f.vertexColors[1].copy(v.geometry.colors[_-1])}T.elements.push(f)}}}}else if(v instanceof THREE.Sprite){H.set(V.elements[12],V.elements[13],V.elements[14],1);H.applyMatrix4(z);var ge=1/H.w;H.z*=ge;if(H.z>=-1&&H.z<=1){d=D();d.id=v.id;d.x=H.x*ge;d.y=H.y*ge;d.z=H.z;d.object=v;d.rotation=v.rotation;d.scale.x=v.scale.x*Math.abs(d.x-(H.x+i.projectionMatrix.elements[0])/(H.w+i.projectionMatrix.elements[12]));d.scale.y=v.scale.y*Math.abs(d.y-(H.y+i.projectionMatrix.elements[5])/(H.w+i.projectionMatrix.elements[13]));d.material=v.material;T.elements.push(d)}}}if(s===true){T.elements.sort(G)}return T};function F(){if(r===i){var e=new THREE.RenderableObject;t.push(e);i++;r++;return e}return t[r++]}function P(){if(o===s){var e=new THREE.RenderableVertex;a.push(e);s++;o++;return e}return a[o++]}function I(){if(c===p){var e=new THREE.RenderableFace;u.push(e);p++;c++;return e}return u[c++]}function O(){if(E===h){var e=new THREE.RenderableLine;v.push(e);h++;E++;return e}return v[E++]}function D(){if(m===x){var e=new THREE.RenderableSprite;R.push(e);x++;m++;return e}return R[m++]}function G(e,r){if(e.z!==r.z){return r.z-e.z}else if(e.id!==r.id){return e.id-r.id}else{return 0}}function U(e,r){var t=0,i=1,n=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;if(n>=0&&o>=0&&a>=0&&s>=0){return true}else if(n<0&&o<0||a<0&&s<0){return false}else{if(n<0){t=Math.max(t,n/(n-o))}else if(o<0){i=Math.min(i,n/(n-o))}if(a<0){t=Math.max(t,a/(a-s))}else if(s<0){i=Math.min(i,a/(a-s))}if(i<t){return false}else{e.lerp(r,t);r.lerp(e,1-i);return true}}}};