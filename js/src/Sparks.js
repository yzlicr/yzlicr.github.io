var t={};t.Emitter=function(i){this._counter=i?i:new t.SteadyCounter(10);this._particles=[];this._initializers=[];this._actions=[];this._activities=[];this._handlers=[];this.callbacks={}};t.Emitter.prototype={_TIMESTEP:15,_timer:null,_lastTime:null,_timerStep:10,_velocityVerlet:true,start:function(){this._lastTime=Date.now();this._timer=setTimeout(this.step,this._timerStep,this);this._isRunning=true},stop:function(){this._isRunning=false;clearTimeout(this._timer)},isRunning:function(){return this._isRunning&true},step:function(t){var i=Date.now();var e=i-t._lastTime;if(!this._velocityVerlet){var o=t._TIMESTEP*20;if(e>=o){e=o}while(e>=t._TIMESTEP){t.update(t._TIMESTEP/1e3);e-=t._TIMESTEP}t._lastTime=i-e}else{t.update(e/1e3);t._lastTime=i}if(t._isRunning)setTimeout(t.step,t._timerStep,t)},update:function(i){var e,o;var n=this._counter.updateEmitter(this,i);for(e=0;e<n;e++){this.createParticle()}n=this._activities.length;for(e=0;e<n;e++){this._activities[e].update(this,i)}n=this._actions.length;var a;var r;var s=this._particles.length;for(o=0;o<n;o++){r=this._actions[o];for(e=0;e<s;++e){a=this._particles[e];r.update(this,a,i)}}for(e=s;e--;){a=this._particles[e];if(a.isDead){this._particles.splice(e,1);this.dispatchEvent("dead",a);t.VectorPool.release(a.position);t.VectorPool.release(a.velocity)}else{this.dispatchEvent("updated",a)}}this.dispatchEvent("loopUpdated")},createParticle:function(){var i=new t.Particle;var e=this._initializers.length,o;for(o=0;o<e;o++){this._initializers[o].initialize(this,i)}this._particles.push(i);this.dispatchEvent("created",i);return i},addInitializer:function(t){this._initializers.push(t)},addAction:function(t){this._actions.push(t)},removeInitializer:function(t){var i=this._initializers.indexOf(t);if(i>-1){this._initializers.splice(i,1)}},removeAction:function(t){var i=this._actions.indexOf(t);if(i>-1){this._actions.splice(i,1)}},addCallback:function(t,i){this.callbacks[t]=i},dispatchEvent:function(t,i){var e=this.callbacks[t];if(e){e(i)}}};t.EVENT_PARTICLE_CREATED="created";t.EVENT_PARTICLE_UPDATED="updated";t.EVENT_PARTICLE_DEAD="dead";t.EVENT_LOOP_UPDATED="loopUpdated";t.SteadyCounter=function(t){this.rate=t;this.leftover=0};t.SteadyCounter.prototype.updateEmitter=function(t,i){var e=i*this.rate+this.leftover;var o=Math.floor(e);this.leftover=e-o;return o};t.ShotCounter=function(t){this.particles=t;this.used=false};t.ShotCounter.prototype.updateEmitter=function(t,i){if(this.used){return 0}else{this.used=true}return this.particles};t.Particle=function(){this.lifetime=0;this.age=0;this.energy=1;this.isDead=false;this.target=null;this.position=t.VectorPool.get().set(0,0,0);this.velocity=t.VectorPool.get().set(0,0,0);this._oldvelocity=t.VectorPool.get().set(0,0,0)};t.Action=function(){this._priority=0};t.Age=function(t){this._easing=t==null?TWEEN.Easing.Linear.None:t};t.Age.prototype.update=function(t,i,e){i.age+=e;if(i.age>=i.lifetime){i.energy=0;i.isDead=true}else{var o=this._easing(i.age/i.lifetime);i.energy=-1*o+1}};t.Move=function(){};t.Move.prototype.update=function(t,i,e){var o=i.position;var n=i.velocity;var a=i._oldvelocity;if(this._velocityVerlet){o.x+=(n.x+a.x)*.5*e;o.y+=(n.y+a.y)*.5*e;o.z+=(n.z+a.z)*.5*e}else{o.x+=n.x*e;o.y+=n.y*e;o.z+=n.z*e}};t.DeathZone=function(t){this.zone=t};t.DeathZone.prototype.update=function(t,i,e){if(this.zone.contains(i.position)){i.isDead=true}};t.ActionZone=function(t,i){this.action=t;this.zone=i};t.ActionZone.prototype.update=function(t,i,e){if(this.zone.contains(i.position)){this.action.update(t,i,e)}};t.Accelerate=function(t,i,e){if(t instanceof THREE.Vector3){this.acceleration=t;return}this.acceleration=new THREE.Vector3(t,i,e)};t.Accelerate.prototype.update=function(t,i,e){var o=this.acceleration;var n=i.velocity;i._oldvelocity.set(n.x,n.y,n.z);n.x+=o.x*e;n.y+=o.y*e;n.z+=o.z*e};t.AccelerateFactor=function(t){this.factor=t};t.AccelerateFactor.prototype.update=function(t,i,e){var o=this.factor;var n=i.velocity;var a=n.length();var r;if(a>0){r=o*e/a;r+=1;n.multiplyScalar(r)}};t.AccelerateVelocity=function(t){this.factor=t};t.AccelerateVelocity.prototype.update=function(t,i,e){var o=this.factor;var n=i.velocity;n.z+=-n.x*o;n.y+=n.z*o;n.x+=n.y*o};t.RandomDrift=function(t,i,e){if(t instanceof THREE.Vector3){this.drift=t;return}this.drift=new THREE.Vector3(t,i,e)};t.RandomDrift.prototype.update=function(t,i,e){var o=this.drift;var n=i.velocity;n.x+=(Math.random()-.5)*o.x*e;n.y+=(Math.random()-.5)*o.y*e;n.z+=(Math.random()-.5)*o.z*e};t.Zone=function(){};t.PointZone=function(t){this.pos=t};t.PointZone.prototype.getLocation=function(){return this.pos};t.PointZone=function(t){this.pos=t};t.PointZone.prototype.getLocation=function(){return this.pos};t.LineZone=function(t,i){this.start=t;this.end=i;this._length=i.clone().sub(t)};t.LineZone.prototype.getLocation=function(){var t=this._length.clone();t.multiplyScalar(Math.random());return t.add(this.start)};t.ParallelogramZone=function(t,i,e){this.corner=t;this.side1=i;this.side2=e};t.ParallelogramZone.prototype.getLocation=function(){var t=this.side1.clone().multiplyScalar(Math.random());var i=this.side2.clone().multiplyScalar(Math.random());t.add(i);return t.add(this.corner)};t.CubeZone=function(t,i,e,o){this.position=t;this.x=i;this.y=e;this.z=o};t.CubeZone.prototype.getLocation=function(){var t=this.position.clone();t.x+=Math.random()*this.x;t.y+=Math.random()*this.y;t.z+=Math.random()*this.z;return t};t.CubeZone.prototype.contains=function(t){var i=this.position.x;var e=this.position.y;var o=this.position.z;var n=this.x;var a=this.y;var r=this.z;if(n<0){i+=n;n=Math.abs(n)}if(a<0){e+=a;a=Math.abs(a)}if(r<0){o+=r;r=Math.abs(r)}var s=t.x-i;var c=t.y-e;var h=t.z-o;if(s>0&&s<n&&c>0&&c<a&&h>0&&h<r){return true}return false};t.SphereCapZone=function(t,i,e,o,n,a){this.x=t;this.y=i;this.z=e;this.minr=o;this.maxr=n;this.angle=a};t.SphereCapZone.prototype.getLocation=function(){var i=Math.PI*2*t.Utils.random();var e=t.Utils.random();var o=t.VectorPool.get().set(e*Math.cos(i),-1/Math.tan(this.angle*t.Utils.DEGREE_TO_RADIAN),e*Math.sin(i));var n=this.minr-(this.minr-this.maxr)*Math.random();o.multiplyScalar(n);o.__markedForReleased=true;return o};t.Lifetime=function(t,i){this._min=t;this._max=i?i:t};t.Lifetime.prototype.initialize=function(i,e){e.lifetime=this._min+t.Utils.random()*(this._max-this._min)};t.Position=function(t){this.zone=t};t.Position.prototype.initialize=function(t,i){var e=this.zone.getLocation();i.position.set(e.x,e.y,e.z)};t.Velocity=function(t){this.zone=t};t.Velocity.prototype.initialize=function(i,e){var o=this.zone.getLocation();e.velocity.set(o.x,o.y,o.z);if(o.__markedForReleased){t.VectorPool.release(o);o.__markedForReleased=false}};t.Target=function(t,i){this.target=t;this.callback=i};t.Target.prototype.initialize=function(t,i){if(this.callback){i.target=this.callback()}else{i.target=this.target}};t.VectorPool={__pools:[],get:function(){if(this.__pools.length>0){return this.__pools.pop()}return this._addToPool()},release:function(t){this.__pools.push(t)},_addToPool:function(){for(var t=0,i=100;t<i;t++){this.__pools.push(new THREE.Vector3)}return new THREE.Vector3}};t.Utils={random:function(){return Math.random()},DEGREE_TO_RADIAN:Math.PI/180,TWOPI:Math.PI*2,getPerpendiculars:function(t){var i=this.getPerpendicular(t);var e=t.cross(i);e.normalize();return[i,e]},getPerpendicular:function(t){if(t.x==0){return new THREE.Vector3D(1,0,0)}else{var i=new THREE.Vector3(t.y,(-t.x),0);return i.normalize()}}};