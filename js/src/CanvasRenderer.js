THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(e,i){};this.setValues(e)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;THREE.Material.prototype.clone.call(this,e);e.color.copy(this.color);e.program=this.program;return e};THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION);var i=THREE.Math.smoothstep;e=e||{};var t=this,n,r,o,a=new THREE.Projector,s=e.canvas!==undefined?e.canvas:document.createElement("canvas"),l=s.width,c=s.height,f=Math.floor(l/2),p=Math.floor(c/2),E=0,d=0,h=l,m=c,u=1,x=s.getContext("2d",{alpha:e.alpha===true}),y=new THREE.Color(0),v=e.alpha===true?0:1,R=1,S=0,T=null,g=null,w=null,H=null,C=null,M=[],L,b,B,P,z,V=new THREE.RenderableVertex,j=new THREE.RenderableVertex,D,W,F,N,k,I,O,G,A,q,U,J,K=new THREE.Color,Q=new THREE.Color,X=new THREE.Color,Y=new THREE.Color,Z=new THREE.Color,$=new THREE.Color,_=new THREE.Color,ee=new THREE.Color,ie={},te,ne,re,oe,ae,se,le,ce,fe=new THREE.Box2,pe=new THREE.Box2,Ee=new THREE.Box2,de=new THREE.Color,he=new THREE.Color,me=new THREE.Color,ue=new THREE.Vector3,xe=new THREE.Vector3,ye=new THREE.Vector3,ve=new THREE.Matrix3;if(x.setLineDash===undefined){x.setLineDash=function(){}}this.domElement=s;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getPixelRatio=function(){return u};this.setPixelRatio=function(e){u=e};this.setSize=function(e,i,t){l=e*u;c=i*u;s.width=l;s.height=c;f=Math.floor(l/2);p=Math.floor(c/2);if(t!==false){s.style.width=e+"px";s.style.height=i+"px"}fe.min.set(-f,-p),fe.max.set(f,p);pe.min.set(-f,-p);pe.max.set(f,p);R=1;S=0;T=null;g=null;w=null;H=null;C=null;this.setViewport(0,0,e,i)};this.setViewport=function(e,i,t,n){E=e*u;d=i*u;h=t*u;m=n*u};this.setScissor=function(){};this.enableScissorTest=function(){};this.setClearColor=function(e,i){y.set(e);v=i!==undefined?i:1;pe.min.set(-f,-p);pe.max.set(f,p)};this.setClearColorHex=function(e,i){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(e,i)};this.getClearColor=function(){return y};this.getClearAlpha=function(){return v};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(pe.empty()===false){pe.intersect(fe);pe.expandByScalar(2);pe.min.x=pe.min.x+f;pe.min.y=-pe.min.y+p;pe.max.x=pe.max.x+f;pe.max.y=-pe.max.y+p;if(v<1){x.clearRect(pe.min.x|0,pe.max.y|0,pe.max.x-pe.min.x|0,pe.min.y-pe.max.y|0)}if(v>0){je(THREE.NormalBlending);Ve(1);ke("rgba("+Math.floor(y.r*255)+","+Math.floor(y.g*255)+","+Math.floor(y.b*255)+","+v+")");x.fillRect(pe.min.x|0,pe.max.y|0,pe.max.x-pe.min.x|0,pe.min.y-pe.max.y|0)}pe.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(e,i){if(i instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}if(this.autoClear===true)this.clear();t.info.render.vertices=0;t.info.render.faces=0;x.setTransform(h/l,0,0,-m/c,E,c-d);x.translate(f,p);n=a.projectScene(e,i,this.sortObjects,this.sortElements);r=n.elements;o=n.lights;L=i;ve.getNormalMatrix(i.matrixWorldInverse);Re();for(var s=0,u=r.length;s<u;s++){var y=r[s];var v=y.material;if(v===undefined||v.opacity===0)continue;Ee.makeEmpty();if(y instanceof THREE.RenderableSprite){b=y;b.x*=f;b.y*=p;Te(b,y,v)}else if(y instanceof THREE.RenderableLine){b=y.v1;B=y.v2;b.positionScreen.x*=f;b.positionScreen.y*=p;B.positionScreen.x*=f;B.positionScreen.y*=p;Ee.setFromPoints([b.positionScreen,B.positionScreen]);if(fe.isIntersectionBox(Ee)===true){ge(b,B,y,v)}}else if(y instanceof THREE.RenderableFace){b=y.v1;B=y.v2;P=y.v3;if(b.positionScreen.z<-1||b.positionScreen.z>1)continue;if(B.positionScreen.z<-1||B.positionScreen.z>1)continue;if(P.positionScreen.z<-1||P.positionScreen.z>1)continue;b.positionScreen.x*=f;b.positionScreen.y*=p;B.positionScreen.x*=f;B.positionScreen.y*=p;P.positionScreen.x*=f;P.positionScreen.y*=p;if(v.overdraw>0){ze(b.positionScreen,B.positionScreen,v.overdraw);ze(B.positionScreen,P.positionScreen,v.overdraw);ze(P.positionScreen,b.positionScreen,v.overdraw)}Ee.setFromPoints([b.positionScreen,B.positionScreen,P.positionScreen]);if(fe.isIntersectionBox(Ee)===true){we(b,B,P,0,1,2,y,v)}}pe.union(Ee)}x.setTransform(1,0,0,1,0,0)};function Re(){de.setRGB(0,0,0);he.setRGB(0,0,0);me.setRGB(0,0,0);for(var e=0,i=o.length;e<i;e++){var t=o[e];var n=t.color;if(t instanceof THREE.AmbientLight){de.add(n)}else if(t instanceof THREE.DirectionalLight){he.add(n)}else if(t instanceof THREE.PointLight){me.add(n)}}}function Se(e,i,t){for(var n=0,r=o.length;n<r;n++){var a=o[n];ee.copy(a.color);if(a instanceof THREE.DirectionalLight){var s=ue.setFromMatrixPosition(a.matrixWorld).normalize();var l=i.dot(s);if(l<=0)continue;l*=a.intensity;t.add(ee.multiplyScalar(l))}else if(a instanceof THREE.PointLight){var s=ue.setFromMatrixPosition(a.matrixWorld);var l=i.dot(ue.subVectors(s,e).normalize());if(l<=0)continue;l*=a.distance==0?1:1-Math.min(e.distanceTo(s)/a.distance,1);if(l==0)continue;l*=a.intensity;t.add(ee.multiplyScalar(l))}}}function Te(e,i,t){Ve(t.opacity);je(t.blending);var n=i.scale.x*f;var r=i.scale.y*p;var o=.5*Math.sqrt(n*n+r*r);Ee.min.set(e.x-o,e.y-o);Ee.max.set(e.x+o,e.y+o);if(t instanceof THREE.SpriteMaterial){var a=t.map;if(a!==null&&a.image!==undefined){if(a.hasEventListener("update",Le)===false){if(a.image.width>0){be(a)}a.addEventListener("update",Le)}var s=ie[a.id];if(s!==undefined){ke(s)}else{ke("rgba( 0, 0, 0, 1 )")}var l=a.image;var c=l.width*a.offset.x;var E=l.height*a.offset.y;var d=l.width*a.repeat.x;var h=l.height*a.repeat.y;var m=n/d;var u=r/h;x.save();x.translate(e.x,e.y);if(t.rotation!==0)x.rotate(t.rotation);x.translate(-n/2,-r/2);x.scale(m,u);x.translate(-c,-E);x.fillRect(c,E,d,h);x.restore()}else{ke(t.color.getStyle());x.save();x.translate(e.x,e.y);if(t.rotation!==0)x.rotate(t.rotation);x.scale(n,-r);x.fillRect(-.5,-.5,1,1);x.restore()}}else if(t instanceof THREE.SpriteCanvasMaterial){Ne(t.color.getStyle());ke(t.color.getStyle());x.save();x.translate(e.x,e.y);if(t.rotation!==0)x.rotate(t.rotation);x.scale(n,r);t.program(x);x.restore()}}function ge(e,i,t,n){Ve(n.opacity);je(n.blending);x.beginPath();x.moveTo(e.positionScreen.x,e.positionScreen.y);x.lineTo(i.positionScreen.x,i.positionScreen.y);if(n instanceof THREE.LineBasicMaterial){De(n.linewidth);We(n.linecap);Fe(n.linejoin);if(n.vertexColors!==THREE.VertexColors){Ne(n.color.getStyle())}else{var r=t.vertexColors[0].getStyle();var o=t.vertexColors[1].getStyle();if(r===o){Ne(r)}else{try{var a=x.createLinearGradient(e.positionScreen.x,e.positionScreen.y,i.positionScreen.x,i.positionScreen.y);a.addColorStop(0,r);a.addColorStop(1,o)}catch(s){a=r}Ne(a)}}x.stroke();Ee.expandByScalar(n.linewidth*2)}else if(n instanceof THREE.LineDashedMaterial){De(n.linewidth);We(n.linecap);Fe(n.linejoin);Ne(n.color.getStyle());Ie([n.dashSize,n.gapSize]);x.stroke();Ee.expandByScalar(n.linewidth*2);Ie([])}}function we(e,n,r,o,a,s,l,c){t.info.render.vertices+=3;t.info.render.faces++;Ve(c.opacity);je(c.blending);D=e.positionScreen.x;W=e.positionScreen.y;F=n.positionScreen.x;N=n.positionScreen.y;k=r.positionScreen.x;I=r.positionScreen.y;He(D,W,F,N,k,I);if((c instanceof THREE.MeshLambertMaterial||c instanceof THREE.MeshPhongMaterial)&&c.map===null){$.copy(c.color);_.copy(c.emissive);if(c.vertexColors===THREE.FaceColors){$.multiply(l.color)}K.copy(de);xe.copy(e.positionWorld).add(n.positionWorld).add(r.positionWorld).divideScalar(3);Se(xe,l.normalModel,K);K.multiply($).add(_);c.wireframe===true?Ce(K,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Me(K)}else if(c instanceof THREE.MeshBasicMaterial||c instanceof THREE.MeshLambertMaterial||c instanceof THREE.MeshPhongMaterial){if(c.map!==null){var f=c.map.mapping;if(f===THREE.UVMapping){ne=l.uvs;Be(D,W,F,N,k,I,ne[o].x,ne[o].y,ne[a].x,ne[a].y,ne[s].x,ne[s].y,c.map)}}else if(c.envMap!==null){if(c.envMap.mapping===THREE.SphericalReflectionMapping){ye.copy(l.vertexNormalsModel[o]).applyMatrix3(ve);re=.5*ye.x+.5;oe=.5*ye.y+.5;ye.copy(l.vertexNormalsModel[a]).applyMatrix3(ve);ae=.5*ye.x+.5;se=.5*ye.y+.5;ye.copy(l.vertexNormalsModel[s]).applyMatrix3(ve);le=.5*ye.x+.5;ce=.5*ye.y+.5;Be(D,W,F,N,k,I,re,oe,ae,se,le,ce,c.envMap)}}else{K.copy(c.color);if(c.vertexColors===THREE.FaceColors){K.multiply(l.color)}c.wireframe===true?Ce(K,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Me(K)}}else if(c instanceof THREE.MeshDepthMaterial){K.r=K.g=K.b=1-i(e.positionScreen.z*e.positionScreen.w,L.near,L.far);c.wireframe===true?Ce(K,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Me(K)}else if(c instanceof THREE.MeshNormalMaterial){ye.copy(l.normalModel).applyMatrix3(ve);K.setRGB(ye.x,ye.y,ye.z).multiplyScalar(.5).addScalar(.5);c.wireframe===true?Ce(K,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Me(K)}else{K.setRGB(1,1,1);c.wireframe===true?Ce(K,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):Me(K)}}function He(e,i,t,n,r,o){x.beginPath();x.moveTo(e,i);x.lineTo(t,n);x.lineTo(r,o);x.closePath()}function Ce(e,i,t,n){De(i);We(t);Fe(n);Ne(e.getStyle());x.stroke();Ee.expandByScalar(i*2)}function Me(e){ke(e.getStyle());x.fill()}function Le(e){be(e.target)}function be(e){if(e instanceof THREE.CompressedTexture)return;var i=e.wrapS===THREE.RepeatWrapping;var t=e.wrapT===THREE.RepeatWrapping;var n=e.image;var r=document.createElement("canvas");r.width=n.width;r.height=n.height;var o=r.getContext("2d");o.setTransform(1,0,0,-1,0,n.height);o.drawImage(n,0,0);ie[e.id]=x.createPattern(r,i===true&&t===true?"repeat":i===true&&t===false?"repeat-x":i===false&&t===true?"repeat-y":"no-repeat")}function Be(e,i,t,n,r,o,a,s,l,c,f,p,E){if(E instanceof THREE.DataTexture)return;if(E.hasEventListener("update",Le)===false){if(E.image!==undefined&&E.image.width>0){be(E)}E.addEventListener("update",Le)}var d=ie[E.id];if(d!==undefined){ke(d)}else{ke("rgba(0,0,0,1)");x.fill();return}var h,m,u,y,v,R,S,T,g=E.offset.x/E.repeat.x,w=E.offset.y/E.repeat.y,H=E.image.width*E.repeat.x,C=E.image.height*E.repeat.y;a=(a+g)*H;s=(s+w)*C;l=(l+g)*H;c=(c+w)*C;f=(f+g)*H;p=(p+w)*C;t-=e;n-=i;r-=e;o-=i;l-=a;c-=s;f-=a;p-=s;S=l*p-f*c;if(S===0)return;T=1/S;h=(p*t-c*r)*T;m=(p*n-c*o)*T;u=(l*r-f*t)*T;y=(l*o-f*n)*T;v=e-h*a-u*s;R=i-m*a-y*s;x.save();x.transform(h,m,u,y,v,R);x.fill();x.restore()}function Pe(e,i,t,n,r,o,a,s,l,c,f,p,E){var d,h,m,u,y,v,R,S,T=E.width-1,g=E.height-1;a*=T;s*=g;l*=T;c*=g;f*=T;p*=g;t-=e;n-=i;r-=e;o-=i;l-=a;c-=s;f-=a;p-=s;R=l*p-f*c;S=1/R;d=(p*t-c*r)*S;h=(p*n-c*o)*S;m=(l*r-f*t)*S;u=(l*o-f*n)*S;y=e-d*a-m*s;v=i-h*a-u*s;x.save();x.transform(d,h,m,u,y,v);x.clip();x.drawImage(E,0,0);x.restore()}function ze(e,i,t){var n=i.x-e.x,r=i.y-e.y,o=n*n+r*r,a;if(o===0)return;a=t/Math.sqrt(o);n*=a;r*=a;i.x+=n;i.y+=r;e.x-=n;e.y-=r}function Ve(e){if(R!==e){x.globalAlpha=e;R=e}}function je(e){if(S!==e){if(e===THREE.NormalBlending){x.globalCompositeOperation="source-over"}else if(e===THREE.AdditiveBlending){x.globalCompositeOperation="lighter"}else if(e===THREE.SubtractiveBlending){x.globalCompositeOperation="darker"}S=e}}function De(e){if(w!==e){x.lineWidth=e;w=e}}function We(e){if(H!==e){x.lineCap=e;H=e}}function Fe(e){if(C!==e){x.lineJoin=e;C=e}}function Ne(e){if(T!==e){x.strokeStyle=e;T=e}}function ke(e){if(g!==e){x.fillStyle=e;g=e}}function Ie(e){if(M.length!==e.length){x.setLineDash(e);M=e}}};